<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="rgLuntan.mapper.TopicMapper">

    <!--<resultMap id="BaseResultMap" type="rgLuntan.model.Topic">
        <id column="id" jdbcType="INTEGER" property="id"/>
    </resultMap>-->

    <!-- 通用查询结果列
    <sql id="Base_Column_List">
        test_id AS testId, name, age, test_type AS testType, role, phone
    </sql>-->

    <select id="selectAll" resultType="map">
        select t.*, u.username, u.avatar
        from topic t
        left join user u on t.user_id = u.id
        <where>
            <if test="tab == 'good'">
                t.good = true
            </if>
            <if test="tab == 'noanswer'">
                t.comment_count = 0
            </if>
            <if test="tab == 'hot'">
                date(t.in_time) &lt;= date_add(curdate(), interval 1 day)
                and date(t.in_time) &gt;= date_sub(curdate(), interval 7 day)
            </if>
        </where>
        <if test="tab == 'all' or tab == 'noanswer' or tab == 'good'">
            order by t.top desc, t.in_time desc
        </if>
        <if test="tab == 'newest'">
            order by t.in_time desc
        </if>
        <if test="tab == 'hot'">
            order by t.comment_count desc, t.in_time desc
        </if>
    </select>

    <select id="selectByTag" resultType="map">
        select t.*, u.username, u.avatar
        from topic t
        left join user u on t.user_id = u.id
        left join topic_tag tt on tt.topic_id = t.id
        left join tag tag on tag.id = tt.tag_id
        <where>
            tag.name = #{tag}
        </where>
        order by t.top desc, t.in_time desc
    </select>

    <select id="selectByForumId" resultType="map">
        select t.*, u.username, u.avatar
        from topic t
                 left join user u on t.user_id = u.id
        where t.forum_id = #{forumId}
        order by t.top desc, t.in_time desc
    </select>

    <select id="selectByUserId" resultType="map">
        select t.*, u.username, u.avatar
        from topic t
        left join user u on t.user_id = u.id
        where t.user_id = #{userId}
        order by t.in_time desc
    </select>

    <select id="selectForAdmin" resultType="map">
        SELECT t.*, u2.username
        FROM topic t
        LEFT JOIN forum f ON t.forum_id = f.id
        LEFT JOIN user u ON f.teacher_id = u.id  -- 保留这个JOIN以获取论坛教师的信息（如果需要）
        LEFT JOIN user u2 ON t.user_id = u2.id  -- 新增的JOIN，用于从topic.user_id获取username
        <where>
            <!-- 如果需要按topic的创建时间范围过滤 -->
            <if test="startDate != null and endDate != null">
                t.in_time BETWEEN #{startDate} AND #{endDate}
            </if>
            <!-- 如果需要按topic的user_id对应的username过滤 -->
            <if test="username != null">
                AND u2.username = #{username}
            </if>
            <!-- 如果需要按论坛教师的user_id过滤（保留原始条件） -->
            <if test="adminUserId != null">
                AND f.teacher_id = #{adminUserId}
            </if>
        </where>
        ORDER BY t.in_time DESC
    </select>

    <select id="selectAllForAdmin" resultType="map">
        select t.*, u.username
        from topic t
        left join user u on t.user_id = u.id
        <where>
            <if test="startDate != null and endDate != null">
                t.in_time between #{startDate} and #{endDate}
            </if>
            <if test="username != null">
                and u.username = #{username}
            </if>
        </where>
        order by t.in_time desc
    </select>

    <select id="countToday" resultType="integer">
        select count(1)
        from topic t
        where t.in_time between curdate() and date_add(curdate(), interval 1 day)
    </select>

<!--    <select id="searchBar" resultType="map">-->
<!--        select t.id, t.title, t.content-->
<!--        from topic t-->
<!--        JOIN forum f ON t.forum_id = f.id-->
<!--        <where>-->
<!--            f.forumsName = #{forumsName}-->
<!--            AND (-->
<!--            t.title like concat(concat('%',#{keyword}),'%')-->
<!--            OR t.content like concat(concat('%',#{keyword}),'%')-->
<!--            )-->
<!--        </where>-->
<!--        order by t.in_time desc-->
<!--    </select>-->

    <select id="searchBar" resultType="map">
        select t.*, u.username, u.avatar
        from topic t
        left join user u on t.user_id = u.id
        left join forum f on t.forum_id = f.id
        <where>
            <!-- Existing filters -->
            <if test="tab == 'good'">
                t.good = true
            </if>
            <if test="tab == 'noanswer'">
                t.comment_count = 0
            </if>
            <if test="tab == 'hot'">
                date(t.in_time) &lt;= date_add(curdate(), interval 1 day)
                and date(t.in_time) &gt;= date_sub(curdate(), interval 7 day)
            </if>

            <if test="tab == 'hot' and forumsName != null and forumsName != ''">
                AND
            </if>

            <!-- New filters for forumsName and keyword -->
            <if test="forumsName != null and forumsName != ''">
                f.forumsName = #{forumsName}
            </if>
            <if test="keyword != null and keyword != ''">
                AND (
                t.title like concat('%', #{keyword}, '%')
                OR t.content like concat('%', #{keyword}, '%')
                )
            </if>
        </where>

        <!-- Sorting conditions -->
        <if test="tab == 'all' or tab == 'noanswer' or tab == 'good'">
            order by t.top desc, t.in_time desc
        </if>
        <if test="tab == 'newest'">
            order by t.in_time desc
        </if>
        <if test="tab == 'hot'">
            order by t.comment_count desc, t.in_time desc
        </if>
    </select>

    <select id="search" resultType="map">
        select t.id, t.title, t.content
        from topic t
        <where>
            t.title like concat(concat('%',#{keyword}),'%') or t.content like concat(concat('%',#{keyword}),'%')
        </where>
        order by t.in_time desc
    </select>

</mapper>
